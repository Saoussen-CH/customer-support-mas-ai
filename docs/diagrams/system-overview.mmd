%% Multi-Agent Customer Support System - System Overview
%% Google Cloud Platform Style

graph TB
    subgraph "User Layer"
        User[üë§ User]
    end

    subgraph "Vertex AI Agent Engine Runtime"
        subgraph "Root Coordinator"
            RootAgent[ü§ñ Root Agent<br/>Model: Gemini 2.5 Pro<br/>Error Handling: Always Respond<br/>Callback: auto_save_to_memory_explicit]
        end

        subgraph "Specialist Agents"
            ProductAgent[üõçÔ∏è Product Agent<br/>Model: Gemini 2.5 Flash<br/>+ PreloadMemoryTool<br/>+ get_product_info default<br/>Callback: auto_save_to_memory_explicit]
            OrderAgent[üì¶ Order Agent<br/>Model: Gemini 2.5 Flash<br/>+ PreloadMemoryTool<br/>Callback: auto_save_to_memory_explicit]
            BillingAgent[üí≥ Billing Agent<br/>Model: Gemini 2.5 Flash<br/>+ PreloadMemoryTool<br/>Note: Refunds via workflow only<br/>Callback: auto_save_to_memory_explicit]
        end

        subgraph "Workflow Patterns"
            RefundWorkflow[üîÑ Sequential Workflow<br/>Model: Gemini 2.5 Pro<br/>3-Step Validation Process<br/>ONLY way to process refunds]
        end

        subgraph "Memory Management"
            Tracking[üìä Memory Callbacks<br/>auto_save_to_memory_explicit: Save session<br/>Creates VertexAiMemoryBankService<br/>Automatic extraction & persistence]
        end
    end

    subgraph "Memory Bank"
        MemoryService[üíæ Memory Bank Service<br/>Generation: Gemini 2.5 Flash<br/>Embedding: text-embedding-004]
        MemoryStore[(Memory Store<br/>USER_PREFERENCES)]
    end

    subgraph "Google Cloud Services"
        Firestore[(üî• Firestore<br/>Products, Orders, Sessions<br/>Vector Search)]
        CloudStorage[‚òÅÔ∏è Cloud Storage<br/>Agent Staging]
    end

    User -->|Query| RootAgent
    RootAgent -->|Route| ProductAgent
    RootAgent -->|Route| OrderAgent
    RootAgent -->|Route| BillingAgent
    RootAgent -->|Route| RefundWorkflow

    ProductAgent -->|RAG Search| Firestore
    OrderAgent -->|Fetch Orders| Firestore
    BillingAgent -->|Fetch Invoices| Firestore

    RootAgent -.->|Save Session| MemoryService
    ProductAgent -.->|Save Session| MemoryService
    OrderAgent -.->|Save Session| MemoryService
    BillingAgent -.->|Save Session| MemoryService

    MemoryService -->|Store| MemoryStore
    ProductAgent -->|Load Memories| MemoryStore

    style User fill:#4285F4,stroke:#1967D2,color:#fff
    style RootAgent fill:#34A853,stroke:#0D652D,color:#fff
    style ProductAgent fill:#FBBC04,stroke:#F29900,color:#000
    style OrderAgent fill:#FBBC04,stroke:#F29900,color:#000
    style BillingAgent fill:#FBBC04,stroke:#F29900,color:#000
    style RefundWorkflow fill:#EA4335,stroke:#C5221F,color:#fff
    style Tracking fill:#34A853,stroke:#0D652D,color:#fff
    style MemoryService fill:#9334E6,stroke:#7627BB,color:#fff
    style MemoryStore fill:#9334E6,stroke:#7627BB,color:#fff
    style Firestore fill:#FF6F00,stroke:#E65100,color:#fff
    style CloudStorage fill:#4285F4,stroke:#1967D2,color:#fff
